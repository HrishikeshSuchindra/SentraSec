import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "motion/react";
import {
  Terminal,
  Play,
  Pause,
  Square,
  Zap,
  Shield,
  CheckCircle,
  XCircle,
  Download,
  Upload,
  Code,
  Trash2,
  Link,
} from "lucide-react";
import { Card } from "../ui/card";
import { Button } from "../ui/button";
import { Badge } from "../ui/badge";
import { Progress } from "../ui/progress";
import { ScrollArea } from "../ui/scroll-area";
import { toast } from "sonner@2.0.3";

const baseModules = [
  {
    id: "web_sql_injection",
    name: "SQL Injection Exploiter",
    category: "Web Application",
    description: "Automated SQL injection vulnerability exploitation",
    targets: ["web-app-01.local", "api-gateway.local"],
    severity: "critical",
    success_rate: 85,
  },
  {
    id: "smb_eternal_blue",
    name: "EternalBlue SMB Exploit",
    category: "Network",
    description: "MS17-010 SMB vulnerability exploitation",
    targets: ["workstation-03.local", "server-02.local"],
    severity: "critical",
    success_rate: 95,
  },
  {
    id: "priv_esc_windows",
    name: "Windows Privilege Escalation",
    category: "Privilege Escalation",
    description: "Local privilege escalation on Windows systems",
    targets: ["workstation-05.local"],
    severity: "high",
    success_rate: 78,
  },
  {
    id: "web_rce_upload",
    name: "File Upload RCE",
    category: "Web Application",
    description: "Remote code execution via malicious file upload",
    targets: ["web-app-02.local"],
    severity: "high",
    success_rate: 72,
  },
];

export function Exploitation() {
  const [modules] = useState(baseModules);
  const [activeExploits, setActiveExploits] = useState([]);
  const [logs, setLogs] = useState([]);
  const [terminalExpanded, setTerminalExpanded] = useState(true);
  const [attackChain, setAttackChain] = useState([]);
  const [activeTargets, setActiveTargets] = useState([]); // For radar pulses

  // ðŸ§  Generate dynamic console logs
  useEffect(() => {
    const active = activeExploits.filter((e) => e.status === "running");
    if (active.length === 0) return;

    const interval = setInterval(() => {
      const randomExp = active[Math.floor(Math.random() * active.length)];
      const messages = [
        `[+] ${randomExp.module}: Payload injected to ${randomExp.target}`,
        `[+] ${randomExp.module}: Gaining reverse shell access...`,
        `[!] ${randomExp.module}: IDS detected packet anomaly`,
        `[+] ${randomExp.module}: Exploit successful, credentials dumped`,
        `[x] ${randomExp.module}: Target hardened, exploit blocked`,
      ];
      const msg = messages[Math.floor(Math.random() * messages.length)];
      setLogs((prev) => [
        ...prev.slice(-80),
        { time: new Date().toLocaleTimeString(), msg },
      ]);
    }, 2000);

    return () => clearInterval(interval);
  }, [activeExploits]);

  const getSeverityColor = (sev) => {
    switch (sev) {
      case "critical":
        return { text: "neon-red", glow: "glow-red" };
      case "high":
        return { text: "text-orange-400", glow: "shadow-orange-500/50" };
      case "medium":
        return { text: "text-yellow-400", glow: "shadow-yellow-500/50" };
      default:
        return { text: "neon-green", glow: "glow-green" };
    }
  };
  const getStatusColor = (status) =>
    status === "success"
      ? "neon-green"
      : status === "failed"
      ? "neon-red"
      : "neon-cyan";

  // ðŸš€ Deploy exploit simulation
  const deployExploit = (mod) => {
    const id = `exp_${Date.now()}`;
    const target = mod.targets[Math.floor(Math.random() * mod.targets.length)];
    const exploit = {
      id,
      module: mod.name,
      target,
      status: "running",
      progress: 0,
    };
    setActiveExploits((prev) => [...prev, exploit]);
    setActiveTargets((prev) => [...prev, target]);
    setLogs((prev) => [
      ...prev,
      {
        time: new Date().toLocaleTimeString(),
        msg: `[+] Deploying ${mod.name} on ${target}`,
      },
    ]);
    toast.info(`Deploying ${mod.name} on ${target}`);

    const interval = setInterval(() => {
      setActiveExploits((prev) =>
        prev.map((e) =>
          e.id === id
            ? { ...e, progress: Math.min(e.progress + Math.random() * 20, 100) }
            : e
        )
      );
    }, 1000);

    setTimeout(() => {
      clearInterval(interval);
      const success = Math.random() > 0.25;
      setActiveExploits((prev) =>
        prev.map((e) =>
          e.id === id
            ? { ...e, progress: 100, status: success ? "success" : "failed" }
            : e
        )
      );
      setActiveTargets((prev) => prev.filter((t) => t !== target));
      setLogs((prev) => [
        ...prev,
        {
          time: new Date().toLocaleTimeString(),
          msg: success
            ? `[+] ${mod.name} succeeded on ${target}`
            : `[x] ${mod.name} failed on ${target}`,
        },
      ]);
      toast[success ? "success" : "error"](
        `${mod.name} ${success ? "succeeded" : "failed"} on ${target}`
      );
    }, 6000);
  };

  // ðŸ§© Attack chain
  const addToChain = (mod) => {
    if (!attackChain.find((m) => m.id === mod.id)) {
      setAttackChain((prev) => [...prev, mod]);
      toast.success(`${mod.name} added to chain`);
    }
  };
  const removeFromChain = (id) => {
    setAttackChain((prev) => prev.filter((m) => m.id !== id));
  };
  const executeChain = async () => {
    toast.message("Executing attack chain...");
    for (const mod of attackChain) {
      deployExploit(mod);
      await new Promise((r) => setTimeout(r, 2000));
    }
  };

  return (
    <div className="p-6 space-y-6 h-full overflow-auto relative">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="holographic text-3xl font-bold">
            Exploitation Engine
          </h1>
          <p className="text-muted-foreground">
            Autonomous exploit deployment and live radar tracking
          </p>
        </div>
        <Button
          className="glass-panel glow-red"
          onClick={() => modules.forEach(deployExploit)}
        >
          <Zap className="w-4 h-4 mr-2" /> Deploy All
        </Button>
      </div>

      {/* Radar Visualization */}
      <Card className="glass-panel p-6 h-72 relative overflow-hidden">
        <h3 className="font-semibold mb-4 neon-cyan">
          Attack Radar Visualization
        </h3>
        <motion.div
          animate={{ rotate: 360 }}
          transition={{ duration: 6, repeat: Infinity, ease: "linear" }}
          className="absolute left-1/2 top-1/2 w-60 h-60 border border-cyan-400/30 rounded-full -translate-x-1/2 -translate-y-1/2"
        />
        {activeTargets.map((t, i) => (
          <motion.div
            key={i}
            initial={{ opacity: 0, scale: 0.5 }}
            animate={{ opacity: [1, 0.3, 1], scale: [1, 1.2, 1] }}
            transition={{ duration: 1.5, repeat: Infinity }}
            className="absolute left-1/2 top-1/2 w-3 h-3 rounded-full bg-red-500 shadow-lg"
            style={{
              transform: `translate(${Math.sin(i) * 120}px, ${
                Math.cos(i) * 120
              }px)`,
            }}
            title={`Target: ${t}`}
          />
        ))}
      </Card>

      {/* Exploit Catalog + Active Exploits */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Catalog */}
        <Card className="glass-panel p-6 h-96 overflow-hidden">
          <h3 className="font-semibold mb-3 neon-purple">Exploit Modules</h3>
          <ScrollArea className="h-80">
            <div className="space-y-3">
              {modules.map((mod) => {
                const { glow, text } = getSeverityColor(mod.severity);
                return (
                  <div key={mod.id} className={`glass-panel p-3 hover:${glow}`}>
                    <div className="flex justify-between items-center">
                      <h4 className="font-medium">{mod.name}</h4>
                      <Badge className={text}>{mod.severity}</Badge>
                    </div>
                    <p className="text-xs text-muted-foreground">
                      {mod.description}
                    </p>
                    <div className="flex justify-end gap-2 mt-2">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => addToChain(mod)}
                      >
                        <Link className="w-3 h-3 mr-1" /> Chain
                      </Button>
                      <Button size="sm" onClick={() => deployExploit(mod)}>
                        <Play className="w-3 h-3 mr-1" /> Deploy
                      </Button>
                    </div>
                  </div>
                );
              })}
            </div>
          </ScrollArea>
        </Card>

        {/* Active Exploits */}
        <Card className="glass-panel p-6 h-96 overflow-auto">
          <h3 className="font-semibold mb-3 neon-green">Active Exploits</h3>
          {activeExploits.length === 0 && (
            <p className="text-sm text-muted-foreground">
              No active exploits yet.
            </p>
          )}
          {activeExploits.map((e) => (
            <div key={e.id} className="glass-panel p-3 space-y-2 mb-2">
              <div className="flex justify-between">
                <div>
                  <span className="font-medium text-sm">{e.module}</span>
                  <div className="font-mono text-xs neon-cyan">{e.target}</div>
                </div>
                <span className={`text-xs ${getStatusColor(e.status)}`}>
                  {e.status}
                </span>
              </div>
              <Progress value={e.progress} className="h-2" />
            </div>
          ))}
        </Card>
      </div>

      {/* Terminal Console */}
      <Card className="glass-panel">
        <div className="p-4 border-b border-border/40 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Terminal className="w-4 h-4 neon-green" />
            <h3 className="font-semibold neon-green">Exploitation Console</h3>
          </div>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setTerminalExpanded(!terminalExpanded)}
          >
            {terminalExpanded ? "Collapse" : "Expand"}
          </Button>
        </div>
        <motion.div
          animate={{ height: terminalExpanded ? 300 : 150 }}
          className="overflow-hidden bg-black/40"
        >
          <ScrollArea className="h-full p-3 font-mono text-xs">
            {logs.length === 0 && (
              <p className="text-muted-foreground">Console ready...</p>
            )}
            {logs.map((log, i) => (
              <div key={i} className="flex gap-2">
                <span className="text-muted-foreground w-20">{log.time}</span>
                <span className="neon-cyan">{log.msg}</span>
              </div>
            ))}
          </ScrollArea>
        </motion.div>
      </Card>

      {/* Attack Chain Builder */}
      <Card className="glass-panel p-6">
        <h3 className="font-semibold mb-4 neon-magenta">
          Attack Chain Builder
        </h3>
        <div className="flex flex-wrap items-center gap-3 bg-black/20 p-4 rounded-lg">
          {attackChain.length === 0 && (
            <span className="text-muted-foreground text-sm">
              Add modules to build your chain.
            </span>
          )}
          {attackChain.map((mod, i) => (
            <motion.div
              key={mod.id}
              className="glass-panel px-3 py-2 rounded-lg flex items-center gap-2"
              whileHover={{ scale: 1.05 }}
            >
              <Shield className="w-4 h-4 text-muted-foreground" />
              <span className="text-xs">{mod.name}</span>
              <Button
                variant="ghost"
                size="icon"
                onClick={() => removeFromChain(mod.id)}
              >
                <Trash2 className="w-3 h-3 text-red-400" />
              </Button>
              {i < attackChain.length - 1 && (
                <Link className="w-4 h-4 text-muted-foreground" />
              )}
            </motion.div>
          ))}
          {attackChain.length > 0 && (
            <Button className="glow-purple neon-purple" onClick={executeChain}>
              <Play className="w-4 h-4 mr-2" /> Execute Chain
            </Button>
          )}
        </div>
      </Card>
    </div>
  );
}
